<html>
    <head>
        <script src="jscolor.js"></script>
        <script src="FileSaver.min.js"></script>
        <script src="canvas-toBlob.js"></script>
        <script>
            var axis = 8
              , mode = 2
              , color = "#000000"
              , thickness = 3
              , width = null
              , height = null
              , mouse_down_event = null
              , mouse_move_event = null
              , mouse_up_event = null
              , main_canvas = null
              , axis_canvas = null
              , draw_canvas = null
              , undo_canvas = null
              , touch_supported = null
              , last_mouse_point = null
              , scale_x = null
              , scale_y = null
              , dots = null
            function clear_clicked() {
                main_canvas_context.clearRect(0, 0, width, height)
            }
            function draw_axis() {
                for (axis_canvas_context.clearRect(0, 0, width, height),
                y = -Math.sqrt(height / 2 * (height / 2) + width / 2 * (width / 2)); y <= Math.sqrt(height / 2 * (height / 2) + width / 2 * (width / 2)); y++) {
                    cords = {
                        x: 0,
                        y: y
                    },
                    draw_pixel(translate_to_canvas_coordinates(cords), axis_canvas_context)
                    for (var e = axis - 1; e > 0; e--)
                        draw_pixel(translate_to_canvas_coordinates(translate_by_pi_times_i(cords, e / axis)), axis_canvas_context)
                }
            }
            function body_loaded() {
                main_canvas = document.getElementById("main_canvas"),
                main_canvas.width = window.innerWidth,
                main_canvas.height = window.innerHeight,
                width = main_canvas.width,
                height = main_canvas.height,
                last_mouse_point = {
                    x: 0,
                    y: 0
                },
                scale_x = 1,
                scale_y = 1,
                dots = [],
                main_canvas_context = document.getElementById("main_canvas").getContext("2d"),
                axis_canvas = document.createElement("canvas"),
                axis_canvas.id = "axis_canvas",
                axis_canvas.width = width,
                axis_canvas.height = height,
                axis_canvas.style.cssText = "position: absolute; left: " + main_canvas.getBoundingClientRect().left + "px; top: " + main_canvas.getBoundingClientRect().top + "px; z-index:1;",
                main_canvas.parentNode.appendChild(axis_canvas),
                axis_canvas_context = axis_canvas.getContext("2d"),
                draw_canvas = document.createElement("canvas"),
                draw_canvas.id = "draw_canvas",
                draw_canvas.width = width,
                draw_canvas.height = height,
                draw_canvas.style.cssText = "position: absolute; left: " + main_canvas.getBoundingClientRect().left + "px; top: " + main_canvas.getBoundingClientRect().top + "px; z-index:3;",
                main_canvas.parentNode.appendChild(draw_canvas),
                draw_canvas_context = draw_canvas.getContext("2d"),
                undo_canvas = document.createElement("canvas"),
                undo_canvas.id = "undo_canvas",
                undo_canvas.width = width,
                undo_canvas.height = height,
                undo_canvas.style.cssText = "position: absolute; left: " + main_canvas.getBoundingClientRect().left + "px; top: " + main_canvas.getBoundingClientRect().top + "px; z-index:0; display:none;",
                main_canvas.parentNode.appendChild(undo_canvas),
                undo_canvas_context = undo_canvas.getContext("2d"),
                draw_axis(),
                touch_supported = "ontouchstart"in document.documentElement,
                touch_supported ? (mouse_down_event = "touchstart",
                mouse_move_event = "touchmove",
                mouse_up_event = "touchend") : (mouse_down_event = "mousedown",
                mouse_move_event = "mousemove",
                mouse_up_event = "mouseup"),
                document.getElementById("draw_canvas").addEventListener(mouse_down_event, on_canvas_mouse_down)
            }
            function on_canvas_mouse_down(e) {
                e.preventDefault(),
                window.addEventListener(mouse_move_event, on_canvas_mouse_move),
                window.addEventListener(mouse_up_event, on_canvas_mouse_up),
                update_mouse_position(e),
                draw_quadratic_curve(dots, color, thickness, draw_canvas_context)
            }
            function on_canvas_mouse_move(e) {
                e.preventDefault(),
                update_mouse_position(e),
                draw_quadratic_curve(dots, color, thickness, draw_canvas_context)
            }
            function draw_quadratic_curve(e, t, n, a, s, o) {
                if (s = void 0 === s ? !0 : s,
                o = void 0 === o ? !1 : o,
                a.strokeStyle = t,
                a.fillStyle = t,
                a.lineWidth = n,
                a.lineJoin = "round",
                a.lineCap = "round",
                s && 0 == o && a.clearRect(0, 0, width, height),
                e.length > 0)
                    if (e.length < 3) {
                        var i = e[0]
                        a.beginPath(),
                        a.arc(i.x, i.y, a.lineWidth / 2, 0, 2 * Math.PI, !0),
                        a.fill(),
                        a.closePath()
                    } else {
                        a.beginPath(),
                        a.moveTo(e[0].x, e[0].y)
                        for (var _ = 1; _ < e.length - 2; _++) {
                            var d = (e[_].x + e[_ + 1].x) / 2
                              , c = (e[_].y + e[_ + 1].y) / 2
                            a.quadraticCurveTo(e[_].x, e[_].y, d, c)
                        }
                        a.quadraticCurveTo(e[_].x, e[_].y, e[_ + 1].x, e[_ + 1].y),
                        a.stroke()
                    }
                if (s && 0 != mode) {
                    for (var _ = 2 * axis - 1; _ > 0; _--) {
                        var u = []
                        for (j = 0; j < e.length; j++) {
                            var l = translate_from_canvas_coordinates(e[j])
                            l = translate_by_pi_times_i(l, _ / axis),
                            l = translate_to_canvas_coordinates(l),
                            u.push(l)
                        }
                        draw_quadratic_curve(u, t, n, draw_canvas_context, !1)
                    }
                    if (2 == mode && 0 == o) {
                        var u = []
                        for (j = 0; j < e.length; j++) {
                            var l = translate_from_canvas_coordinates(e[j])
                            l.x = -l.x,
                            l = translate_to_canvas_coordinates(l),
                            u.push(l)
                        }
                        draw_quadratic_curve(u, t, n, draw_canvas_context, !0, !0)
                    }
                }
            }
            function on_canvas_mouse_up(e) {
                e.preventDefault(),
                window.removeEventListener(mouse_move_event, on_canvas_mouse_move),
                window.removeEventListener(mouse_up_event, on_canvas_mouse_up),
                undo_canvas_context.drawImage(main_canvas, 0, 0),
                main_canvas_context.drawImage(draw_canvas, 0, 0),
                draw_canvas_context.clearRect(0, 0, width, height),
                document.getElementById("undo_button").disabled = !1,
                dots = []
            }
            function update_mouse_position(e) {
                var t
                t = touch_supported ? e.touches[0] : e,
                last_mouse_point.x = t.pageX - draw_canvas.offsetLeft,
                last_mouse_point.y = t.pageY - draw_canvas.offsetTop,
                last_mouse_point.x /= scale_x,
                last_mouse_point.y /= scale_y
                var n = {
                    x: last_mouse_point.x,
                    y: last_mouse_point.y
                }
                if ((dots.length < 1 || dots[dots.length - 1].x != n.x || dots[dots.length - 1].y != n.y) && dots.push(n),
                dots.length > 1 && Math.sqrt(Math.pow(dots[dots.length - 1].x - dots[dots.length - 2].x, 2) + Math.pow(dots[dots.length - 1].y - dots[dots.length - 2].y, 2)) > 15 * (width + height) / 100)
                    for (var a = dots.length - 1; a > 0; )
                        dots.shift(),
                        a--
            }
            function draw_pixel(e, t) {
                t.fillStyle = "#EBEBEB",
                t.fillRect(e.x, e.y, 1, 1)
            }
            function translate_from_canvas_coordinates(e) {
                return {
                    x: e.x - width / 2,
                    y: -1 * (e.y - height / 2)
                }
            }
            function translate_to_canvas_coordinates(e) {
                return {
                    x: e.x + width / 2,
                    y: -e.y + height / 2
                }
            }
            function translate_by_pi_times_i(e, t) {
                var n = Math.sqrt(Math.pow(e.x, 2) + Math.pow(e.y, 2))
                  , a = Math.atan2(e.y, e.x)
                return a += Math.PI * t,
                {
                    x: n * Math.cos(a),
                    y: n * Math.sin(a)
                }
            }
            function undo_clicked() {
                document.getElementById("undo_button").disabled = !0,
                main_canvas_context.clearRect(0, 0, width, height),
                main_canvas_context.drawImage(undo_canvas, 0, 0)
            }
            function thickness_slider_minus() {
                document.getElementById("thickness_slider").value > 1 && (document.getElementById("thickness_slider").value = parseInt(document.getElementById("thickness_slider").value) - 1,
                document.getElementById("thickness_value").value = document.getElementById("thickness_slider").value,
                thickness = document.getElementById("thickness_value").value)
            }
            function thickness_slider_plus() {
                document.getElementById("thickness_slider").value < 40 && (document.getElementById("thickness_slider").value = parseInt(document.getElementById("thickness_slider").value) + 1,
                document.getElementById("thickness_value").value = document.getElementById("thickness_slider").value,
                thickness = document.getElementById("thickness_value").value)
            }
            function axis_count_slider_minus() {
                document.getElementById("axis_count_slider").value > 1 && (document.getElementById("axis_count_slider").value = parseInt(document.getElementById("axis_count_slider").value) - 1,
                document.getElementById("range_value").value = document.getElementById("axis_count_slider").value,
                axis = document.getElementById("range_value").value,
                draw_axis())
            }
            function axis_count_slider_plus() {
                document.getElementById("axis_count_slider").value < 100 && (document.getElementById("axis_count_slider").value = parseInt(document.getElementById("axis_count_slider").value) + 1,
                document.getElementById("range_value").value = document.getElementById("axis_count_slider").value,
                axis = document.getElementById("range_value").value,
                draw_axis())
            }
        </script>
    </head>
    <body onLoad="body_loaded();" style="padding:0; margin:0; font-size:11pt;">
        <div id="style" style="position:absolute; top:5px; left:5px; z-index:100; font-family:Monaco; background-color:#ffffff; filter:alpha(opacity=70); -moz-opacity:0.7; -khtml-opacity:0.7; opacity:0.7;">
            axis count: <button type="button" style="border:2px solid black; font-family:Monaco" onClick="axis_count_slider_minus();">&lt;</button>
            <input id="axis_count_slider" type="range" style="border:2px solid black; font-family:Monaco" min="1" max="100" step="1" onInput="axis=this.value; draw_axis(); document.getElementById('range_value').value=this.value;" value="8">
            <button type="button" style="border:2px solid black; font-family:Monaco" onClick="axis_count_slider_plus();">&gt;</button>
            <input type="text" id="range_value" value="8" size="3" style="border:2px solid black; font-family:Monaco" readonly/>
            &nbsp;&nbsp;&nbsp;color: <input class="jscolor" style="border:2px solid black; font-family:Monaco" onChange="color='#'+this.value;" value="#000000" readonly="true" size="6"/>
            &nbsp;&nbsp;&nbsp;thickness: <button type="button" style="border:2px solid black; font-family:Monaco" onClick="thickness_slider_minus();">&lt;</button>
            <input id="thickness_slider" type="range" style="border:2px solid black; font-family:Monaco" min="1" max="40" step="1" onInput="thickness=this.value; document.getElementById('thickness_value').value=this.value;" value="3">
            <button type="button" style="border:2px solid black; font-family:Monaco" onClick="thickness_slider_plus();">&gt;</button>
            <input type="text" id="thickness_value" value="3" size="3" style="border:2px solid black; font-family:Monaco" readonly>
            &nbsp;&nbsp;&nbsp;mode: 
            <select style="border:2px solid black; font-family:Monaco" onChange="mode=this.value">
                <option value="0">No Repeat</option>
                <option value="1">Translate Only</option>
                <option value="2" selected="selected">Mirror &Translate</option>
            </select>
            &nbsp;&nbsp;&nbsp;hide axis: <input type="checkbox" style="border:2px solid black; font-family:Monaco" onChange="if( this.checked ) { document.getElementById('axis_canvas').style.display='none'; } else { document.getElementById('axis_canvas').style.display=''; }"/>
            &nbsp;&nbsp;<button type="button" id="undo_button" style="border:2px solid black; font-family:Monaco" onClick="undo_clicked();">Undo</button>
            &nbsp;<button type="button" style="border:2px solid black; font-family:Monaco" onClick="clear_clicked();">Clear</button>
            &nbsp;<button type="button" style="border:2px solid black; font-family:Monaco" onClick="main_canvas.toBlob(function(blob){saveAs(blob,'mandala.png');});">Save</button>
        </div>
        <canvas id="main_canvas" width="800" height="800" style="z-index:2;"></canvas>
    </body>
</html>
